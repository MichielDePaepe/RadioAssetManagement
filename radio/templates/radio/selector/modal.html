<!-- radio/search/modal.html -->

<div class="modal fade" id="radioSelectorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">{{ title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="radio-modal-body">

        {% csrf_token %}

        <!-- STEP 1: Inputs -->
        <div id="modal-inputs">

          <div class="mb-3">
            <div class="input-group">
              <input type="text" id="radio-issi" class="form-control" placeholder="ISSI">
              <button class="btn btn-primary search-btn" id="search-issi-btn" data-type="issi">Zoek</button>
            </div>
            <div class="form-text text-danger" id="error-issi"></div>
          </div>

          <div class="mb-3">
            <div class="input-group">
              <input type="text" id="radio-tei" class="form-control" placeholder="TEI">
              <button class="btn btn-primary search-btn" id="search-tei-btn" data-type="tei">Zoek</button>
            </div>
            <div class="form-text text-danger" id="error-tei"></div>
          </div>

        </div>

        <!-- STEP 2: Resultaat -->
        <div id="modal-result" class="mt-3" style="display:none;"></div>

      </div>

    </div>
  </div>
</div>



<script>

  const modalElement = document.getElementById("radioSelectorModal");
  const inputsDiv = document.getElementById("modal-inputs");
  const resultDiv = document.getElementById("modal-result");

  let currentBtn = null;
  let currentCallback = null;

  document.querySelectorAll(".open-radio-modal").forEach(btn => {
    btn.addEventListener("click", () => {
      const cbName = btn.dataset.callback;
      if (cbName && window[cbName]) {
        currentCallback = window[cbName];
      } else if (window.radio_selector_callback) {
        currentCallback = window.radio_selector_callback;
      } else {
        console.error("no callback function was found");
        currentCallback = null;
      }
      currentBtn = btn;
    });
  });

  function resertToInputs() {
    inputsDiv.style.display = "block";
    resultDiv.style.display = "none";
    resultDiv.innerHTML = "";
    document.getElementById("radio-issi").value = "";
    document.getElementById("radio-tei").value = "";
    document.getElementById("error-issi").textContent = "";
    document.getElementById("error-tei").textContent = "";
  }

  modalElement.addEventListener('hidden.bs.modal', resertToInputs);


  document.querySelectorAll(".search-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const type = btn.dataset.type;
      const input = document.getElementById(`radio-${type}`);
      const errorDiv = document.getElementById(`error-${type}`);

      errorDiv.textContent = "";
      resultDiv.innerHTML = "";

      const value = input.value.trim();
      if (!value) {
          errorDiv.textContent = "Vul een waarde in.";
          return;
      }

      const formData = new FormData();
      formData.append("type", type);
      formData.append("value", value);

      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      try {
        const res = await fetch("{% url 'radio:lookup' %}", {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken },
            body: formData
        });
        const data = await res.json();

        if (data.status == "success") {

          inputsDiv.style.display = "none";

          resultDiv.style.display = "block";
          resultDiv.innerHTML = `
              <p><strong>ISSI:</strong> ${data.ISSI}</p>
              <p><strong>TEI:</strong> ${data.tei_str}</p>
              <p><strong>Alias:</strong> ${data.alias}</p>
              <div class="d-flex justify-content-end">
                  <button class="btn btn-secondary me-2" id="cancel-radio">Annuleer</button>
                  <button 
                    class="btn btn-success" 
                    id="confirm-radio" 
                    data-tei="${data.tei_str}"
                    data-issi="${data.ISSI}"
                    data-alias="${data.alias}"
                    data-str="${data.radio}"
                  >
                    Selecteren
                  </button>
              </div>
          `;
        } else {
          errorDiv.textContent = data.message;
        }
      } catch (err) {
        errorDiv.textContent = "Er is een fout opgetreden bij het zoeken.";
        console.error(err);
      }
    });
  });

resultDiv.addEventListener("click", e => {
  if (e.target.id === "cancel-radio") {
    resertToInputs();
  } else if (e.target.id === "confirm-radio") {
    const data = e.target.dataset;
    if (currentCallback) {
      currentCallback(currentBtn, data);
    }
    bootstrap.Modal.getInstance(modalElement).hide();
  }
});

</script>