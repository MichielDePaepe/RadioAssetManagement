{% extends 'base.html' %}
{% load i18n %}

{% block extra_script %}

<script src="https://cdn.jsdelivr.net/npm/timeago.js@4.0.2/dist/timeago.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/timeago.js@4.0.2/dist/timeago.locales.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    timeago.render(document.querySelectorAll('.timeago'), 'nl');
  });
</script>

{% endblock %}

{% block content %}

<h1>Radio info</h1>

<hr>

<div class="d-flex flex-column align-items-center mt-3">

  <!-- Tabel -->
  <table class="table table-bordered w-auto text-center">
    <tbody>
      <tr>
        <th scope="row" class="bg-light">Type</th>
        <td>{{ radio.model }}</td>
      </tr>
      <tr>
        <th scope="row" class="bg-light">TEI</th>
        <td>{{ radio.tei_str }}</td>
      </tr>
      <tr>
        <th scope="row" class="bg-light">ISSI</th>
        <td>{{ radio.ISSI }}</td>
      </tr>
      <tr>
        <th scope="row" class="bg-light">Alias</th>
        <td>{{ radio.alias }}</td>
      </tr>
      <tr>
        <th scope="row" class="bg-light">Status</th>
        <td>
          {% if radio.is_active %}
            <span class="badge bg-success">{% trans "Actief" %}</span>
          {% elif radio.is_DMO_only %}
            <span class="badge bg-info">{% trans "DMO only" %}</span>
          {% elif radio.decommissioned %}
            <span class="badge bg-warning">{% trans "Decommissioned" %}</span>
          {% else %}
            <span class="badge bg-danger">{% trans "Niet actief" %}</span>
          {% endif %}
        </td>
      </tr>
      {% if radio.container_link %}
      <tr>
        <th scope="row" class="bg-light">Voorziene plaats</th>
        <td>
          {{ radio.container_link.container }}: {{ radio.container_link.name }}
          {% if radio.container_link.container.vector.vehicle %}
            <br>
            
            {{ radio.container_link.container.vector.statusCode.status_icon_html }}
            {{ radio.container_link.container.vector.vehicle.call_sign }}
          {% endif %}
        </td>
      </tr>
      {% endif %}

      {% if radio.vehicle %}
      <tr>
        <th scope="row" class="bg-light">Voertuig</th>
        <td>
          {{ radio.vehicle }}
        </td>
      </tr>
      {% endif %}

      {% if radio.vehicle.vector %}
      <tr>
        <th scope="row" class="bg-light">Vector</th>
        <td>
            {{ radio.vehicle.vector.statusCode.status_icon_html }}
            {{ radio.vehicle.vector.name }}
        </td>
      </tr>
      {% endif %}

      {% if radio.inventory_entries.exists %}
      <tr>
        <th scope="row" class="bg-light">Laatst gezien</th>
        <td>
          {{ radio.inventory_entries.latest.container }} <br>
          <time class="timeago" datetime="{{ radio.inventory_entries.latest.timestamp|date:'c' }}"></time>
        </td>
      </tr>
      {% endif %}
    </tbody>
  </table>




<div class="card mt-3">
  <div class="card-header bg-primary text-white">
    Print labels
  </div>
  <div class="card-body">

    <form method="post">
      {% csrf_token %}
      <div class="d-flex align-items-end gap-3 mb-3">
        <div class="flex-grow-1">
          <label for="printer" class="form-label mb-0">Printer</label>
          <select name="printer_id" id="printer" class="form-select form-select-sm">
            {% for p in printers %}
              <option value="{{ p.id }}">{{ p.name }} ({{ p.device }})</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="copies" class="form-label mb-0">Kopies</label>
          <input type="number" name="copies" id="copies" value="1" min="1" max="10" class="form-control form-control-sm" style="width: 60px;">
        </div>
      </div>

      <!-- QR -->
      {% if radio.fireplan_id %}
  <div class="d-flex justify-content-between align-items-center mb-2">
    <img src="{% url 'radio:label_image' radio.pk 'qr' %}" alt="QR Label" class="img-fluid border" style="height:68px; width:auto;">
    <button type="submit" name="action" value="qr" class="btn btn-primary btn-print">
      <i class="bi bi-printer-fill"></i>
      <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
    </button>
  </div>
      {% else %}
<div class="alert alert-warning text-center" role="alert">
  {% trans "Deze radio heeft geen Fireplan ID, QR-printen niet mogelijk." %}
</div>
{% endif %}

      <!-- TEI -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <img src="{% url 'radio:label_image' radio.pk 'tei_label' %}" alt="TEI Label" class="img-fluid border" style="height:45px; width:auto;">
        <button type="submit" name="action" value="tei" class="btn btn-primary btn-print">
          <i class="bi bi-printer-fill"></i>
      <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        </button>
      </div>

      <!-- Mobile -->
      {% if radio.model.radio_type == 'MOBILE' %}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <img src="{% url 'radio:label_image' radio.pk 'mobile_label' %}" alt="Mobile Label" class="img-fluid border" style="height:45px; width:auto;">
        <button type="submit" name="action" value="label" class="btn btn-primary btn-print">
          <i class="bi bi-printer-fill"></i>
      <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        </button>
      </div>
      {% endif %}

    </form>

  </div>
</div>


<div class="card mt-4 w-100">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Tickets gelinkt aan deze radio</span>

    <a href="{% url 'helpdesk:ticket_new_with_radio' radio_pk=radio.pk %}" 
       class="btn btn-primary btn-sm">
      <i class="bi bi-plus-circle"></i> Nieuw ticket
    </a>
  </div>
  <div class="card-body p-3">
    {% if tickets %}
    <table class="table table-sm mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th scope="col">ID</th>
          <th scope="col">Titel</th>
          <th scope="col">Type</th>
          <th scope="col">Status</th>
          <th scope="col">Laatst bijgewerkt</th>
        </tr>
      </thead>
      <tbody>
        {% for t in tickets %}
        <tr>
          <td>
            {% if t.ticket_type.code == "ASTRID_REQUEST" %}
              <a href="{% url 'astrid:request_detail' t.pk %}">#{{ t.id }}</a>
            {% else %}
              <a href="{% url 'helpdesk:ticket_detail' t.pk %}">#{{ t.id }}</a>
            {% endif %}
          </td>
          <td>
            {{ t.title }}
          </td>
          <td>{{ t.ticket_type.name }}</td>
          <td>
            <span class="badge bg-light text-dark">{{ t.status.name }}</span>
          </td>
          <td><time class="timeago" datetime="{{ t.updated_at|date:'c' }}"></time></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="alert alert-info mt-4 w-100 text-center">
      Geen tickets gekoppeld aan deze radio.
    </div>
    {% endif %}
  </div>
</div>





</div>

<script>
document.querySelectorAll('.btn-print').forEach(btn => {
  btn.addEventListener('click', function() {
    event.preventDefault(); // stop default submit

    // hide printer icon and show spinner on clicked button
    const icon = this.querySelector('i');
    const spinner = this.querySelector('.spinner-border');

    if (icon) icon.classList.add('d-none');      // hide printer icon
    if (spinner) spinner.classList.remove('d-none'); // show spinner

    // disable all buttons
    document.querySelectorAll('.btn-print').forEach(b => b.disabled = true);

    // submit form with the clicked button's action
    const hidden = document.createElement('input');
    hidden.type = 'hidden';
    hidden.name = this.name;
    hidden.value = this.value;
    this.form.appendChild(hidden);

    // Submit form
    this.form.submit();

  });
});
</script>


{% endblock %}