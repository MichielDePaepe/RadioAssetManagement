{% extends "base.html" %}

{% block title %}Nieuw Ticket met QR Scan{% endblock %}

{% block extra_head %}
<style>
  #scanner {
    opacity: 0;
    position: absolute;
    left: -9999px;
  }
  #ticket-form {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<h2 id="title">Scan eerst een radio</h2>

<input type="text" id="scanner" autofocus>

<div class="row mt-3" id="ticket-form">
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button class="btn btn-primary" type="submit">Ticket aanmaken</button>
  </form>
</div>
{% endblock %}

{% block extra_script %}
<script>
  const input = document.getElementById('scanner');
  const formDiv = document.getElementById('ticket-form');
  const radioSelect = document.getElementById('id_radio');

  function focusInput() {
  input.focus();
}

document.addEventListener('click', focusInput);
document.addEventListener('keydown', focusInput);
window.addEventListener('blur', () => setTimeout(focusInput, 100));

input.focus();

input.addEventListener('keypress', function (e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    const scannedData = input.value.trim();
    input.value = '';

    if (!scannedData) return;

    fetch('{% url "inventory:scan_code" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ url: scannedData })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'ok') {
        // stop focusInput event listeners
        document.removeEventListener('click', focusInput);
        document.removeEventListener('keydown', focusInput);
        window.removeEventListener('blur', () => setTimeout(focusInput, 100));

        // rest van je code...
        const tei = String(data.TEI).padStart(14, '0');
        for (let option of radioSelect.options) {
          if (option.text.includes(tei) || option.value === data.TEI.toString()) {
            option.selected = true;
            break;
          }
        }
        formDiv.style.display = 'block';
        document.querySelector('h2').textContent = 'Radio gescand: ' + tei;
        radioSelect.focus();
      } else {
        alert('Radio niet gevonden: ' + data.message);
      }
    })
    .catch(err => {
      alert('Fout bij scannen: ' + err);
    });
  }
});

</script>
{% endblock %}
