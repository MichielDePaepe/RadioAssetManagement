{% extends "base.html" %}
{% load static i18n %}

{% block content %}
<div class="container py-4">

  <div class="row g-4 align-items-start">
    <!-- LIVE (fixed height, doesn't grow with history) -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm" style="min-height: 220px;">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-broadcast"></i>
            <strong>{% trans "Live uitzending" %}</strong>
          </div>
          <span id="liveBadge" class="badge bg-secondary">{% trans "Idle" %}</span>
        </div>

        <div class="card-body">
          <div id="liveEmpty" class="text-center text-muted py-4">
            <div class="display-6 mb-2">—</div>
            <div>{% trans "Geen uitzending" %}</div>
          </div>

          <div id="liveBox" class="d-none">
            <div class="d-flex align-items-start justify-content-between">
              <div>
                <div class="h4 mb-1" id="liveAlias">—</div>
                <div class="text-muted" id="liveVehicleVector">—</div>
              </div>
              <span class="badge bg-danger">{% trans "ON AIR" %}</span>
            </div>

            <hr>

            <div class="d-flex justify-content-between text-muted small">
              <div>
                <i class="bi bi-clock"></i>
                <span id="liveSince">—</span>
              </div>
              <div>
                <i class="bi bi-hdd"></i>
                <span id="liveNode">—</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- HISTORY -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-clock-history"></i>
            <strong>{% trans "Laatste opnames" %}</strong>
          </div>
          <span class="text-muted small">{% trans "max. 20" %}</span>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="text-nowrap">{% trans "Tijdstip" %}</th>
                  <th>{% trans "Alias" %}</th>
                  <th class="text-nowrap">{% trans "Voertuig" %}</th>
                  <th>{% trans "Vector" %}</th>
                  <th class="text-nowrap text-end">{% trans "Lengte" %}</th>
                  <th class="text-end">{% trans "Opname" %}</th>
                </tr>
              </thead>
              <tbody id="historyBody">
                <!-- rows injected by JS -->
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <div class="text-muted small mt-2">
        <i class="bi bi-info-circle"></i>
        {% trans "Klik op play om de opname te beluisteren. Klik opnieuw om te stoppen." %}
      </div>

    </div>
  </div>

</div>

<!-- stable hidden audio element -->
<audio id="hiddenPlayer" preload="none" style="display:none"></audio>

{% endblock %}

{% block extra_script %}
<script>
(() => {
  const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws/live/tx/";
  const ws = new WebSocket(wsUrl);

  const historyBody = document.getElementById("historyBody");
  const player = document.getElementById("hiddenPlayer");

  const liveBadge = document.getElementById("liveBadge");
  const liveEmpty = document.getElementById("liveEmpty");
  const liveBox = document.getElementById("liveBox");
  const liveAlias = document.getElementById("liveAlias");
  const liveVehicleVector = document.getElementById("liveVehicleVector");
  const liveSince = document.getElementById("liveSince");
  const liveNode = document.getElementById("liveNode");

  const rowsByKey = new Map();

  let currentKey = null;
  let currentUrl = null;

  // live state (single radio assumption)
  let liveVisible = false;
  let liveHideTimer = null;

  function formatAliasOrIssi(ev) {
    const alias = ev?.issi?.alias || ev?.alias;
    const issi = ev?.issi?.number || ev?.issi;
    return (alias && String(alias).trim().length) ? alias : (issi ?? "—");
  }

  function getVehicle(ev) {
    return ev?.vehicle?.call_sign || ev?.vehicle?.number || "—";
  }

  function getVector(ev) {
    return ev?.vector?.name || ev?.vector?.abbreviation || "—";
  }

  function fmtDuration(seconds) {
    if (seconds == null) return "—";
    const s = Math.max(0, Math.round(seconds));
    const mm = String(Math.floor(s / 60)).padStart(2, "0");
    const ss = String(s % 60).padStart(2, "0");
    return `${mm}:${ss}`;
  }

  function fmtTime(ts) {
    if (!ts) return "—";
    const d = new Date(ts * 1000);
    return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  }

  function recordingUrl(ev) {
    if (ev.media_url) return ev.media_url;
    if (!ev.filename) return null;
    return `/media/recordings/${encodeURIComponent(ev.filename)}`;
  }

  function setButtonState(key, isPlaying) {
    const row = rowsByKey.get(key);
    if (!row) return;
    const btn = row.querySelector("button[data-action='toggle']");
    if (!btn) return;

    btn.dataset.playing = isPlaying ? "1" : "0";
    btn.innerHTML = isPlaying
      ? `<i class="bi bi-pause-fill"></i>`
      : `<i class="bi bi-play-fill"></i>`;
    btn.classList.toggle("btn-success", !isPlaying);
    btn.classList.toggle("btn-danger", isPlaying);
  }

  function stopPlayback() {
    if (currentKey) setButtonState(currentKey, false);
    player.pause();
    player.removeAttribute("src");
    player.load();
    currentKey = null;
    currentUrl = null;
  }

  async function startPlayback(key, url) {
    if (currentKey && currentKey !== key) {
      setButtonState(currentKey, false);
    }

    currentKey = key;
    currentUrl = url;

    player.src = url;

    try {
      await player.play();
      setButtonState(key, true);
    } catch (e) {
      console.warn("play failed", e);
      setButtonState(key, false);
      currentKey = null;
      currentUrl = null;
    }
  }

  player.addEventListener("ended", () => {
    if (currentKey) setButtonState(currentKey, false);
    currentKey = null;
    currentUrl = null;
  });

  function showLive(ev) {
    // cancel hide timer if any
    if (liveHideTimer) {
      clearTimeout(liveHideTimer);
      liveHideTimer = null;
    }

    liveVisible = true;
    liveBadge.className = "badge bg-danger";
    liveBadge.textContent = "ON AIR";

    liveEmpty.classList.add("d-none");
    liveBox.classList.remove("d-none");

    const alias = formatAliasOrIssi(ev);
    const veh = getVehicle(ev);
    const vec = getVector(ev);

    liveAlias.textContent = alias;

    // only show vehicle/vector if they exist
    const parts = [];
    if (veh && veh !== "—") parts.push(veh);
    if (vec && vec !== "—") parts.push(vec);
    liveVehicleVector.textContent = parts.length ? parts.join(" · ") : "—";

    liveSince.textContent = fmtTime(ev.ts);
    liveNode.textContent = ev.node_id || "—";
  }

  function hideLiveWithDelay() {
    liveHideTimer = setTimeout(() => {
      liveVisible = false;

      liveBadge.className = "badge bg-secondary";
      liveBadge.textContent = "Idle";

      liveBox.classList.add("d-none");
      liveEmpty.classList.remove("d-none");
    }, 2000);
  }

  function upsertStopRow(ev) {
    const key = ev.filename || `${ev.node_id || "node"}:${ev.ts || Date.now()}`;
    const url = recordingUrl(ev);

    let row = rowsByKey.get(key);

    const alias = formatAliasOrIssi(ev);
    const veh = getVehicle(ev);
    const vec = getVector(ev);
    const dur = fmtDuration(ev.duration_s);
    const t = fmtTime(ev.ts);

    if (!row) {
      row = document.createElement("tr");
      row.dataset.key = key;

      row.innerHTML = `
        <td class="text-nowrap" data-col="time"></td>
        <td data-col="alias"></td>
        <td class="text-nowrap" data-col="vehicle"></td>
        <td data-col="vector"></td>
        <td class="text-nowrap text-end" data-col="duration"></td>
        <td class="text-end">
          <button type="button"
                  class="btn btn-sm btn-success"
                  data-action="toggle"
                  data-key="${key}"
                  ${url ? `data-url="${url}"` : "disabled"}
                  title="${url ? "Play/Pause" : "No recording"}">
            <i class="bi bi-play-fill"></i>
          </button>
        </td>
      `;

      historyBody.insertBefore(row, historyBody.firstChild);
      rowsByKey.set(key, row);

      while (historyBody.children.length > 20) {
        const last = historyBody.lastElementChild;
        if (!last) break;
        const lastKey = last.dataset.key;

        if (lastKey && lastKey === currentKey) stopPlayback();

        rowsByKey.delete(lastKey);
        last.remove();
      }
    }

    row.querySelector("[data-col='time']").textContent = t;
    row.querySelector("[data-col='alias']").textContent = alias;
    row.querySelector("[data-col='vehicle']").textContent = (veh && veh !== "—") ? veh : "—";
    row.querySelector("[data-col='vector']").textContent = (vec && vec !== "—") ? vec : "—";
    row.querySelector("[data-col='duration']").textContent = dur;

    const btn = row.querySelector("button[data-action='toggle']");
    if (btn) {
      if (url) {
        btn.disabled = false;
        btn.dataset.url = url;
      }
      if (key === currentKey) {
        setButtonState(key, !player.paused);
      }
    }
  }

  historyBody.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action='toggle']");
    if (!btn) return;

    const key = btn.dataset.key;
    const url = btn.dataset.url;
    if (!url) return;

    // toggle same recording
    if (currentKey === key) {
      if (!player.paused) stopPlayback();
      else startPlayback(key, url);
      return;
    }

    // play different recording
    startPlayback(key, url);
  });

  ws.onmessage = (event) => {
    let ev;
    try { ev = JSON.parse(event.data); } catch { return; }

    if (ev.type === "tx_start") {
      showLive(ev);
      return;
    }

    if (ev.type === "tx_stop") {
      upsertStopRow(ev);

      // live box disappears after 2s
      if (liveVisible) hideLiveWithDelay();
      return;
    }
  };

  ws.onopen = () => console.log("ws connected");
  ws.onclose = () => console.log("ws closed");
})();
</script>
{% endblock %}