{% extends 'base.html' %}
{% load i18n %}

{% block content %}

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">

      <div class="text-center mb-4">
        <h1 class="h3 mb-1">{% trans "Live uitzending" %}</h1>
        <div class="text-muted small" id="wsStatus">connecting…</div>
      </div>

      <div class="row g-4 align-items-start">
        <!-- LEFT: Current TX (fixed height, won't grow with right column) -->
        <div class="col-12 col-lg-5">
          <div class="card shadow-sm border-0" style="height: 360px;">
            <div class="card-body p-4 d-flex flex-column">

              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center gap-2">
                  <span class="badge rounded-pill bg-secondary" id="txBadge">IDLE</span>
                  <span class="text-muted small" id="sinceText"></span>
                </div>
                <span class="badge rounded-pill bg-light text-dark border" id="nodeText"></span>
              </div>

              <div class="row g-3 flex-grow-1">
                <div class="col-12">
                  <div class="text-muted small">{% trans "ISSI" %}</div>
                  <div class="fs-3 fw-semibold" id="issiText">—</div>
                </div>

                <div class="col-12">
                  <div class="text-muted small">{% trans "Alias" %}</div>
                  <div class="fs-5" id="aliasText">—</div>
                </div>

                <div class="col-md-6">
                  <div class="text-muted small">{% trans "Voertuig" %}</div>
                  <div class="fs-6" id="vehicleText">—</div>
                </div>

                <div class="col-md-6">
                  <div class="text-muted small">{% trans "Vector" %}</div>
                  <div class="fs-6" id="vectorText">—</div>
                </div>
              </div>

              <div class="d-flex justify-content-end">
                <button class="btn btn-sm btn-outline-secondary" id="clearBtn" type="button">
                  <i class="bi bi-x-circle"></i> {% trans "Clear" %}
                </button>
              </div>

            </div>
          </div>
        </div>

        <!-- RIGHT: History (tx_stop only) -->
        <div class="col-12 col-lg-7">
          <div class="card shadow-sm border-0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <span class="fw-semibold">{% trans "Laatste opnames" %}</span>
              <span class="badge bg-light text-dark border" id="eventCount">0</span>
            </div>

            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm mb-0 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th style="width:110px;">{% trans "Tijdstip" %}</th>
                      <th>{% trans "Alias" %}</th>
                      <th style="width:90px;">{% trans "Voertuig" %}</th>
                      <th>{% trans "Vector" %}</th>
                      <th style="width:90px;" class="text-end">{% trans "Lengte" %}</th>
                      <th style="width:90px;" class="text-nowrap">{% trans "Opname" %}</th>
                    </tr>
                  </thead>
                  <tbody id="eventsBody">
                    <tr>
                      <td colspan="6" class="text-center text-muted py-4">{% trans "Nog geen opnames." %}</td>
                    </tr>
                  </tbody>
                  <tbody id="historyBody"></tbody>
                  <audio id="hiddenPlayer" preload="none" style="display:none"></audio>
                </table>
              </div>
            </div>

            <div class="card-footer bg-white text-muted small">
              <i class="bi bi-broadcast"></i> /ws/live/tx/
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block extra_script %}
<script>
(() => {
  const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws/live/tx/";
  const ws = new WebSocket(wsUrl);

  const historyBody = document.getElementById("historyBody");
  const player = document.getElementById("hiddenPlayer");

  // Keep stable identity per recording
  // key = filename (best unique)
  const rowsByKey = new Map();

  // Current playback state
  let currentKey = null;        // filename that is playing (or null)
  let currentUrl = null;

  function formatAliasOrIssi(ev) {
    const alias = ev?.issi?.alias || ev?.alias;
    const issi = ev?.issi?.number || ev?.issi;
    return alias && alias.trim().length ? alias : (issi ?? "—");
  }

  function getVehicle(ev) {
    return ev?.vehicle?.call_sign || ev?.vehicle?.number || "—";
  }

  function getVector(ev) {
    return ev?.vector?.name || ev?.vector?.abbreviation || "—";
  }

  function fmtDuration(seconds) {
    if (seconds == null) return "—";
    const s = Math.max(0, Math.round(seconds));
    const mm = String(Math.floor(s / 60)).padStart(2, "0");
    const ss = String(s % 60).padStart(2, "0");
    return `${mm}:${ss}`;
  }

  function fmtTime(ts) {
    // ts is unix seconds
    if (!ts) return "—";
    const d = new Date(ts * 1000);
    return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  }

  function recordingUrl(ev) {
    // Prefer media_url if you add it later
    if (ev.media_url) return ev.media_url;
    if (!ev.filename) return null;
    return `/media/recordings/${encodeURIComponent(ev.filename)}`;
  }

  function setButtonState(key, isPlaying) {
    const row = rowsByKey.get(key);
    if (!row) return;
    const btn = row.querySelector("button[data-action='toggle']");
    if (!btn) return;

    btn.dataset.playing = isPlaying ? "1" : "0";
    btn.innerHTML = isPlaying
      ? `<i class="bi bi-pause-fill"></i>`
      : `<i class="bi bi-play-fill"></i>`;
    btn.classList.toggle("btn-success", !isPlaying);
    btn.classList.toggle("btn-danger", isPlaying);
  }

  function stopPlayback() {
    if (currentKey) {
      setButtonState(currentKey, false);
    }
    player.pause();
    player.removeAttribute("src"); // force unload
    player.load();
    currentKey = null;
    currentUrl = null;
  }

  async function startPlayback(key, url) {
    // stop previous if any
    if (currentKey && currentKey !== key) {
      setButtonState(currentKey, false);
    }

    currentKey = key;
    currentUrl = url;

    player.src = url;

    try {
      await player.play();
      setButtonState(key, true);
    } catch (e) {
      // Autoplay can fail; user gesture should allow it though
      console.warn("play failed", e);
      setButtonState(key, false);
      currentKey = null;
      currentUrl = null;
    }
  }

  // If audio ends naturally -> reset button
  player.addEventListener("ended", () => {
    if (currentKey) setButtonState(currentKey, false);
    currentKey = null;
    currentUrl = null;
  });

  // Build or update a row WITHOUT replacing DOM nodes (prevents playback glitches)
  function upsertStopRow(ev) {
    const key = ev.filename || `${ev.node_id || "node"}:${ev.ts || Date.now()}`;
    const url = recordingUrl(ev);

    let row = rowsByKey.get(key);
    const alias = formatAliasOrIssi(ev);
    const veh = getVehicle(ev);
    const vec = getVector(ev);
    const dur = fmtDuration(ev.duration_s);
    const t = fmtTime(ev.ts);

    if (!row) {
      row = document.createElement("tr");
      row.dataset.key = key;
      row.innerHTML = `
        <td class="text-nowrap" data-col="time"></td>
        <td data-col="alias"></td>
        <td class="text-nowrap" data-col="vehicle"></td>
        <td data-col="vector"></td>
        <td class="text-nowrap text-end" data-col="duration"></td>
        <td class="text-end">
          <button type="button"
                  class="btn btn-sm btn-success"
                  data-action="toggle"
                  data-key="${key}"
                  ${url ? `data-url="${url}"` : "disabled"}
                  title="${url ? "Play/Pause" : "No recording"}">
            <i class="bi bi-play-fill"></i>
          </button>
        </td>
      `;

      // prepend newest first
      historyBody.insertBefore(row, historyBody.firstChild);
      rowsByKey.set(key, row);

      // keep only last 20
      while (historyBody.children.length > 20) {
        const last = historyBody.lastElementChild;
        if (!last) break;
        const lastKey = last.dataset.key;
        // If removing the currently playing row -> stop playback
        if (lastKey && lastKey === currentKey) stopPlayback();
        rowsByKey.delete(lastKey);
        last.remove();
      }
    }

    // Update text cells
    row.querySelector("[data-col='time']").textContent = t;
    row.querySelector("[data-col='alias']").textContent = alias;
    row.querySelector("[data-col='vehicle']").textContent = veh;
    row.querySelector("[data-col='vector']").textContent = vec;
    row.querySelector("[data-col='duration']").textContent = dur;

    // Update url if needed, but DO NOT reset playback if it's the same row playing
    const btn = row.querySelector("button[data-action='toggle']");
    if (btn) {
      if (url) {
        btn.disabled = false;
        btn.dataset.url = url;
      }
      if (key === currentKey) {
        // keep pause icon if playing
        setButtonState(key, !player.paused);
      }
    }
  }

  // Event delegation for play/pause buttons
  historyBody.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action='toggle']");
    if (!btn) return;

    const key = btn.dataset.key;
    const url = btn.dataset.url;
    if (!url) return;

    // toggle same recording
    if (currentKey === key) {
      if (!player.paused) {
        stopPlayback();
      } else {
        startPlayback(key, url);
      }
      return;
    }

    // play different recording
    startPlayback(key, url);
  });

  // WS handling: only store STOP in history
  ws.onmessage = (event) => {
    let ev;
    try { ev = JSON.parse(event.data); } catch { return; }

    if (ev.type === "tx_stop") {
      upsertStopRow(ev);
    }
  };

  ws.onopen = () => console.log("ws connected");
  ws.onclose = () => console.log("ws closed");
})();
</script>
{% endblock %}