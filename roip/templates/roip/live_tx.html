{% extends "base.html" %}
{% load static i18n %}

{% block content %}
<div class="container py-4">

  <!-- LIVE (top) -->
  <div class="row g-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-broadcast"></i>
            <strong>{% trans "Live uitzending" %}</strong>
          </div>
          <span id="liveBadge" class="badge bg-secondary">{% trans "Idle" %}</span>
        </div>

        <div class="card-body" style="min-height: 200px;">
          <div id="liveEmpty" class="text-center text-muted py-4">
            <div class="display-6 mb-2">—</div>
            <div>{% trans "Geen uitzending" %}</div>
          </div>

          <div id="liveBox" class="d-none">
            <div class="d-flex align-items-start justify-content-between">
              <div>
                <div class="h2 mb-1" id="liveHeadline">—</div>
                <div class="text-muted" id="liveSubline">—</div>
              </div>
              <span class="badge bg-danger">{% trans "ON AIR" %}</span>
            </div>

            <hr>

            <div class="d-flex justify-content-between text-muted small">
              <div>
                <i class="bi bi-clock"></i>
                <span id="liveSince">—</span>
              </div>
              <div>
                <i class="bi bi-hdd"></i>
                <span id="liveNode">—</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- HISTORY (bottom) -->
  <div class="row g-4 mt-1">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-clock-history"></i>
            <strong>{% trans "Laatste opnames" %}</strong>
          </div>
          <span class="text-muted small">{% trans "max. 20" %}</span>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="text-nowrap">{% trans "Tijdstip" %}</th>
                  <th>{% trans "Alias" %}</th>
                  <th class="text-nowrap">{% trans "Voertuig" %}</th>
                  <th>{% trans "Vector" %}</th>
                  <th class="text-nowrap text-end">{% trans "Lengte" %}</th>
                  <th class="text-end">{% trans "Opname" %}</th>
                </tr>
              </thead>
              <tbody id="historyBody">
                <!-- rows injected by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="text-muted small mt-2">
        <i class="bi bi-info-circle"></i>
        {% trans "Klik op play om te luisteren. Klik opnieuw om te stoppen." %}
      </div>
    </div>
  </div>

</div>

<audio id="hiddenPlayer" preload="none" style="display:none"></audio>
{% endblock %}

{% block extra_script %}
<script>
(() => {
  const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws/live/tx/";
  const ws = new WebSocket(wsUrl);

  const historyBody = document.getElementById("historyBody");
  const player = document.getElementById("hiddenPlayer");

  const liveBadge = document.getElementById("liveBadge");
  const liveEmpty = document.getElementById("liveEmpty");
  const liveBox = document.getElementById("liveBox");

  const liveHeadline = document.getElementById("liveHeadline");
  const liveSubline = document.getElementById("liveSubline");
  const liveSince = document.getElementById("liveSince");
  const liveNode = document.getElementById("liveNode");

  const rowsByKey = new Map();

  let currentKey = null;
  let currentUrl = null;

  let liveVisible = false;
  let liveHideTimer = null;

  function issiNumber(ev) {
    return ev?.issi?.number ?? ev?.issi ?? null;
  }
  function aliasValue(ev) {
    return ev?.issi?.alias || ev?.alias || "";
  }
  function vehicleCallsign(ev) {
    return ev?.vehicle?.call_sign || ev?.vehicle?.number || "";
  }
  function vectorName(ev) {
    return ev?.vector?.name || ev?.vector?.abbreviation || "";
  }

  // LIVE formatting rules:
  // - If vehicle exists: "CALLSIGN - VECTOR" in large (vector may be missing -> just CALLSIGN)
  // - Else if vector missing: alias in large
  // - Else if only ISSI: ISSI in large
  // Subline: always ISSI in grey if available (and not already only thing shown)
  function formatLive(ev) {
    const issi = issiNumber(ev);
    const alias = (aliasValue(ev) || "").trim();
    const veh = (vehicleCallsign(ev) || "").trim();
    const vec = (vectorName(ev) || "").trim();

    let headline = "—";
    let subline = "—";

    if (veh) {
      headline = vec ? `${veh} - ${vec}` : veh;
      subline = issi ? `ISSI ${issi}` : (alias || "—");
    } else if (alias) {
      headline = alias;
      subline = issi ? `ISSI ${issi}` : "—";
    } else if (issi) {
      headline = String(issi);
      subline = "—";
    } else {
      headline = "—";
      subline = "—";
    }

    return { headline, subline, issi };
  }

  function fmtDuration(seconds) {
    if (seconds == null) return "—";
    const s = Math.max(0, Math.round(seconds));
    const mm = String(Math.floor(s / 60)).padStart(2, "0");
    const ss = String(s % 60).padStart(2, "0");
    return `${mm}:${ss}`;
  }

  function fmtTime(ts) {
    if (!ts) return "—";
    const d = new Date(ts * 1000);
    return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  }

  function recordingUrl(ev) {
    if (ev.media_url) return ev.media_url;
    if (!ev.filename) return null;
    return `/media/recordings/${encodeURIComponent(ev.filename)}`;
  }

  function setButtonState(key, isPlaying) {
    const row = rowsByKey.get(key);
    if (!row) return;
    const btn = row.querySelector("button[data-action='toggle']");
    if (!btn) return;

    btn.dataset.playing = isPlaying ? "1" : "0";
    btn.innerHTML = isPlaying ? `<i class="bi bi-pause-fill"></i>` : `<i class="bi bi-play-fill"></i>`;
    btn.classList.toggle("btn-success", !isPlaying);
    btn.classList.toggle("btn-danger", isPlaying);
  }

  function stopPlayback() {
    if (currentKey) setButtonState(currentKey, false);
    player.pause();
    player.removeAttribute("src");
    player.load();
    currentKey = null;
    currentUrl = null;
  }

  async function startPlayback(key, url) {
    if (currentKey && currentKey !== key) setButtonState(currentKey, false);

    currentKey = key;
    currentUrl = url;
    player.src = url;

    try {
      await player.play();
      setButtonState(key, true);
    } catch (e) {
      console.warn("play failed", e);
      setButtonState(key, false);
      currentKey = null;
      currentUrl = null;
    }
  }

  player.addEventListener("ended", () => {
    if (currentKey) setButtonState(currentKey, false);
    currentKey = null;
    currentUrl = null;
  });

  function showLive(ev) {
    if (liveHideTimer) { clearTimeout(liveHideTimer); liveHideTimer = null; }

    liveVisible = true;
    liveBadge.className = "badge bg-danger";
    liveBadge.textContent = "ON AIR";

    liveEmpty.classList.add("d-none");
    liveBox.classList.remove("d-none");

    const f = formatLive(ev);
    liveHeadline.textContent = f.headline;
    liveSubline.textContent = f.subline;

    liveSince.textContent = fmtTime(ev.ts);
    liveNode.textContent = ev.node_id || "—";
  }

  function hideLiveWithDelay() {
    liveHideTimer = setTimeout(() => {
      liveVisible = false;

      liveBadge.className = "badge bg-secondary";
      liveBadge.textContent = "Idle";

      liveBox.classList.add("d-none");
      liveEmpty.classList.remove("d-none");
    }, 2000);
  }

  function formatHistoryAlias(ev) {
    const alias = (aliasValue(ev) || "").trim();
    const issi = issiNumber(ev);
    if (alias) return alias;
    if (issi) return String(issi);
    return "—";
  }

  function formatHistoryVehicle(ev) {
    const v = (vehicleCallsign(ev) || "").trim();
    return v || "—";
  }

  function formatHistoryVector(ev) {
    const vec = (vectorName(ev) || "").trim();
    return vec || "—";
  }

  function upsertStopRow(ev) {
    const key = ev.filename || `${ev.node_id || "node"}:${ev.ts || Date.now()}`;
    const url = recordingUrl(ev);

    let row = rowsByKey.get(key);

    const t = fmtTime(ev.ts);
    const alias = formatHistoryAlias(ev);
    const veh = formatHistoryVehicle(ev);
    const vec = formatHistoryVector(ev);
    const dur = fmtDuration(ev.duration_s);

    if (!row) {
      row = document.createElement("tr");
      row.dataset.key = key;

      row.innerHTML = `
        <td class="text-nowrap" data-col="time"></td>
        <td data-col="alias"></td>
        <td class="text-nowrap" data-col="vehicle"></td>
        <td data-col="vector"></td>
        <td class="text-nowrap text-end" data-col="duration"></td>
        <td class="text-end">
          <button type="button"
                  class="btn btn-sm btn-success"
                  data-action="toggle"
                  data-key="${key}"
                  ${url ? `data-url="${url}"` : "disabled"}
                  title="${url ? "Play/Pause" : "No recording"}">
            <i class="bi bi-play-fill"></i>
          </button>
        </td>
      `;

      historyBody.insertBefore(row, historyBody.firstChild);
      rowsByKey.set(key, row);

      while (historyBody.children.length > 20) {
        const last = historyBody.lastElementChild;
        if (!last) break;
        const lastKey = last.dataset.key;

        if (lastKey && lastKey === currentKey) stopPlayback();

        rowsByKey.delete(lastKey);
        last.remove();
      }
    }

    row.querySelector("[data-col='time']").textContent = t;
    row.querySelector("[data-col='alias']").textContent = alias;
    row.querySelector("[data-col='vehicle']").textContent = veh;
    row.querySelector("[data-col='vector']").textContent = vec;
    row.querySelector("[data-col='duration']").textContent = dur;

    const btn = row.querySelector("button[data-action='toggle']");
    if (btn) {
      if (url) { btn.disabled = false; btn.dataset.url = url; }
      if (key === currentKey) setButtonState(key, !player.paused);
    }
  }

  historyBody.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action='toggle']");
    if (!btn) return;

    const key = btn.dataset.key;
    const url = btn.dataset.url;
    if (!url) return;

    if (currentKey === key) {
      if (!player.paused) stopPlayback();
      else startPlayback(key, url);
      return;
    }

    startPlayback(key, url);
  });

  ws.onmessage = (event) => {
    let ev;
    try { ev = JSON.parse(event.data); } catch { return; }

    if (ev.type === "tx_start") {
      showLive(ev);
      return;
    }

    if (ev.type === "tx_stop") {
      upsertStopRow(ev);
      if (liveVisible) hideLiveWithDelay();
      return;
    }
  };

  ws.onopen = () => console.log("ws connected");
  ws.onclose = () => console.log("ws closed");
})();
</script>
{% endblock %}