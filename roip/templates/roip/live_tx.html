{% extends 'base.html' %}
{% load i18n %}

{% block content %}

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">

      <div class="text-center mb-4">
        <h1 class="h3 mb-1">{% trans "Live uitzending" %}</h1>
        <div class="text-muted small" id="wsStatus">connecting…</div>
      </div>

      <div class="row g-4 align-items-start">
        <!-- LEFT: Current TX (fixed height, won't grow with right column) -->
        <div class="col-12 col-lg-5">
          <div class="card shadow-sm border-0" style="height: 360px;">
            <div class="card-body p-4 d-flex flex-column">

              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center gap-2">
                  <span class="badge rounded-pill bg-secondary" id="txBadge">IDLE</span>
                  <span class="text-muted small" id="sinceText"></span>
                </div>
                <span class="badge rounded-pill bg-light text-dark border" id="nodeText"></span>
              </div>

              <div class="row g-3 flex-grow-1">
                <div class="col-12">
                  <div class="text-muted small">{% trans "ISSI" %}</div>
                  <div class="fs-3 fw-semibold" id="issiText">—</div>
                </div>

                <div class="col-12">
                  <div class="text-muted small">{% trans "Alias" %}</div>
                  <div class="fs-5" id="aliasText">—</div>
                </div>

                <div class="col-md-6">
                  <div class="text-muted small">{% trans "Voertuig" %}</div>
                  <div class="fs-6" id="vehicleText">—</div>
                </div>

                <div class="col-md-6">
                  <div class="text-muted small">{% trans "Vector" %}</div>
                  <div class="fs-6" id="vectorText">—</div>
                </div>
              </div>

              <div class="d-flex justify-content-end">
                <button class="btn btn-sm btn-outline-secondary" id="clearBtn" type="button">
                  <i class="bi bi-x-circle"></i> {% trans "Clear" %}
                </button>
              </div>

            </div>
          </div>
        </div>

        <!-- RIGHT: History (tx_stop only) -->
        <div class="col-12 col-lg-7">
          <div class="card shadow-sm border-0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <span class="fw-semibold">{% trans "Laatste opnames" %}</span>
              <span class="badge bg-light text-dark border" id="eventCount">0</span>
            </div>

            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm mb-0 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th style="width:110px;">{% trans "Tijdstip" %}</th>
                      <th>{% trans "Alias" %}</th>
                      <th style="width:90px;">{% trans "Voertuig" %}</th>
                      <th>{% trans "Vector" %}</th>
                      <th style="width:90px;" class="text-end">{% trans "Lengte" %}</th>
                      <th style="width:140px;" class="text-nowrap">{% trans "Opname" %}</th>
                    </tr>
                  </thead>
                  <tbody id="eventsBody">
                    <tr>
                      <td colspan="6" class="text-center text-muted py-4">{% trans "Nog geen opnames." %}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card-footer bg-white text-muted small">
              <i class="bi bi-broadcast"></i> /ws/live/tx/
            </div>
          </div>
        </div>

      </div>

      <!-- Global player (used by right list) -->
      <div class="card shadow-sm border-0 mt-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">{% trans "Player" %}</div>
            <a class="small text-decoration-none" id="recordingLink" href="#" target="_blank" rel="noopener" style="display:none;">
              {% trans "Open" %} <i class="bi bi-box-arrow-up-right"></i>
            </a>
          </div>

          <audio id="audioPlayer" controls preload="none" style="width:100%;" class="d-none">
            <source id="audioSource" src="" type="audio/ogg">
          </audio>

          <div class="text-muted small" id="playerHint">{% trans "Klik op play bij een opname." %}</div>
        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block extra_script %}
<script>
  // If recordings are on same host: const RECORDINGS_BASE_URL = "/media/recordings/";
  const RECORDINGS_BASE_URL = "http://192.168.20.196/media/recordings/";
  const MAX_EVENTS = 20;
  const LIVE_CLEAR_DELAY_MS = 2000;

  const els = {
    wsStatus: document.getElementById("wsStatus"),
    txBadge: document.getElementById("txBadge"),
    sinceText: document.getElementById("sinceText"),
    nodeText: document.getElementById("nodeText"),
    issiText: document.getElementById("issiText"),
    aliasText: document.getElementById("aliasText"),
    vehicleText: document.getElementById("vehicleText"),
    vectorText: document.getElementById("vectorText"),
    clearBtn: document.getElementById("clearBtn"),

    audio: document.getElementById("audioPlayer"),
    audioSource: document.getElementById("audioSource"),
    playerHint: document.getElementById("playerHint"),
    recordingLink: document.getElementById("recordingLink"),

    eventsBody: document.getElementById("eventsBody"),
    eventCount: document.getElementById("eventCount"),
  };

  const state = {
    events: [], // tx_stop only, newest first
    liveClearTimer: null,
  };

  function wsUrl(path) {
    const scheme = (location.protocol === "https:") ? "wss" : "ws";
    return `${scheme}://${location.host}${path}`;
  }

  function getIssiNumber(ev) {
    if (ev.issi && typeof ev.issi === "object") return ev.issi.number ?? null;
    return ev.issi ?? null;
  }

  function getAlias(ev) {
    if (ev.issi && typeof ev.issi === "object") return ev.issi.alias ?? null;
    return ev.alias ?? null;
  }

  function getVehicle(ev) {
    return ev.vehicle?.call_sign || ev.vehicle?.number || null;
  }

  function getVector(ev) {
    return ev.vector?.name || ev.vector?.abbreviation || ev.vector?.resourceCode || null;
  }

  function fmtTime(ts) {
    if (!ts) return "—";
    return new Date(ts * 1000).toLocaleTimeString();
  }

  function fmtDuration(seconds) {
    if (seconds == null) return "—";
    const s = Math.max(0, Number(seconds));
    if (!Number.isFinite(s)) return "—";
    if (s < 60) return `${s.toFixed(1)}s`;
    const m = Math.floor(s / 60);
    const r = Math.round(s % 60);
    return `${m}m${String(r).padStart(2, "0")}s`;
  }

  function clearLiveTimer() {
    if (state.liveClearTimer) {
      clearTimeout(state.liveClearTimer);
      state.liveClearTimer = null;
    }
  }

  function setIdle() {
    clearLiveTimer();

    els.txBadge.textContent = "IDLE";
    els.txBadge.className = "badge rounded-pill bg-secondary";
    els.sinceText.textContent = "";
    els.nodeText.textContent = "";

    els.issiText.textContent = "—";
    els.aliasText.textContent = "—";
    els.vehicleText.textContent = "—";
    els.vectorText.textContent = "—";
  }

  function setLive(ev) {
    clearLiveTimer();

    els.txBadge.textContent = "LIVE";
    els.txBadge.className = "badge rounded-pill bg-danger";

    els.sinceText.textContent = ev.ts ? `since ${fmtTime(ev.ts)}` : "";
    els.nodeText.textContent = ev.node_id || "";

    const issi = getIssiNumber(ev);
    const alias = getAlias(ev);

    // If no alias: show ISSI in alias field, and keep ISSI field as number
    els.issiText.textContent = issi ?? "—";
    els.aliasText.textContent = alias ? alias : (issi ? String(issi) : "—");

    els.vehicleText.textContent = getVehicle(ev) || "—";
    els.vectorText.textContent = getVector(ev) || "—";
  }

  function setPlayer(filename) {
    if (!filename) return;

    const url = `${RECORDINGS_BASE_URL}${filename}`;

    els.audio.classList.remove("d-none");
    els.playerHint.classList.add("d-none");

    els.audio.pause();
    els.audio.currentTime = 0;

    els.audioSource.src = url;
    els.audio.load();

    els.recordingLink.href = url;
    els.recordingLink.style.display = "inline";
  }

  function pushStopEvent(ev) {
    state.events.unshift(ev);
    if (state.events.length > MAX_EVENTS) state.events.length = MAX_EVENTS;
    els.eventCount.textContent = String(state.events.length);
  }

  function renderStops() {
    if (state.events.length === 0) {
      els.eventsBody.innerHTML = `
        <tr><td colspan="6" class="text-center text-muted py-4">{% trans "Nog geen opnames." %}</td></tr>
      `;
      return;
    }

    els.eventsBody.innerHTML = state.events.map((ev) => {
      const time = fmtTime(ev.ts);

      const issi = getIssiNumber(ev);
      const alias = getAlias(ev);
      const displayName = alias ? alias : (issi ? String(issi) : "—");

      const vehicle = getVehicle(ev) || "—";
      const vector = getVector(ev) || "—";
      const length = fmtDuration(ev.duration_s);

      let recCell = `<span class="text-muted">—</span>`;
      if (ev.filename) {
        const url = `${RECORDINGS_BASE_URL}${ev.filename}`;
        recCell = `
          <button class="btn btn-sm btn-outline-primary" data-play="${ev.filename}" type="button">
            <i class="bi bi-play-fill"></i>
          </button>
          <a class="btn btn-sm btn-outline-secondary ms-1" href="${url}" target="_blank" rel="noopener">
            <i class="bi bi-box-arrow-up-right"></i>
          </a>
        `;
      }

      return `
        <tr>
          <td class="text-muted text-nowrap">${time}</td>
          <td class="fw-semibold">${displayName}</td>
          <td class="text-nowrap">${vehicle}</td>
          <td>${vector}</td>
          <td class="text-end text-nowrap">${length}</td>
          <td class="text-nowrap">${recCell}</td>
        </tr>
      `;
    }).join("");

    els.eventsBody.querySelectorAll("button[data-play]").forEach(btn => {
      btn.addEventListener("click", () => {
        const filename = btn.getAttribute("data-play");
        setPlayer(filename);
      });
    });
  }

  function handleEvent(ev) {
    if (!ev || !ev.type) return;

    if (ev.type === "tx_start") {
      setLive(ev);
      return;
    }

    if (ev.type === "tx_stop") {
      // store only stop events
      pushStopEvent(ev);
      renderStops();

      // clear live panel after 2s
      clearLiveTimer();
      state.liveClearTimer = setTimeout(() => {
        setIdle();
      }, LIVE_CLEAR_DELAY_MS);

      return;
    }
  }

  els.clearBtn.addEventListener("click", setIdle);

  const ws = new WebSocket(wsUrl("/ws/live/tx/"));
  ws.onopen = () => { els.wsStatus.textContent = "connected"; };
  ws.onclose = () => { els.wsStatus.textContent = "disconnected"; };
  ws.onerror = () => { els.wsStatus.textContent = "error"; };
  ws.onmessage = (e) => {
    try { handleEvent(JSON.parse(e.data)); }
    catch (err) { console.error("bad message", e.data, err); }
  };

  setIdle();
  renderStops();
</script>
{% endblock %}