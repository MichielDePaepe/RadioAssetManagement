{% extends "base.html" %}
{% load i18n static %}

{% block content %}

<h1 class="mb-3">
	{% blocktrans with type=object.request_type id=object.id %}
		{{ type }} request #{{ id }}
	{% endblocktrans %}
</h1>
<hr>




<div class="container-fluid" style="max-width: 600px;">

  <div class="mb-2 d-flex align-items-start">
    <strong class="me-2 flex-shrink-0" style="width: 40%;">{% trans "Description" %}:</strong>
    <div class="flex-grow-1">
      {{ object.description }}
    </div>
  </div>

  <!-- SIAMU ticket -->
  {% if object.siamu_ticket %}
  <div class="mb-2 d-flex align-items-center">
    <strong class="me-2 flex-shrink-0" style="width: 40%;">{% trans "SIAMU ticket" %}:</strong>
    <div class="flex-grow-1">
      <a href="http://helpdesk.firebru2k8.local/helpdesk/ticket.aspx?tid={{ object.siamu_ticket }}"
         target="_blank" class="text-decoration-none">
        #{{ object.siamu_ticket }}
      </a>
    </div>
  </div>
  {% endif %}

  <!-- TEI oude radio -->
  {% if "VTEI" in object.request_type %}
  <div class="mb-2 d-flex align-items-center">
    <strong class="me-2 flex-shrink-0" style="width: 40%;">{% trans "TEI oude radio" %}:</strong>
    <div class="position-relative flex-grow-1">
      <input type="text" class="form-control copy-field" value="{{ object.old_radio.tei_str }}" readonly>
      <i class="fa fa-copy position-absolute top-50 end-0 translate-middle-y me-2 text-muted" style="cursor:pointer"></i>
    </div>
  </div>
  {% endif %}

  <!-- ISSI oude radio -->
  {% if "VISSI" in object.request_type %}
  <div class="mb-2 d-flex align-items-center">
    <strong class="me-2 flex-shrink-0" style="width: 40%;">{% trans "ISSI oude radio" %}:</strong>
    <div class="position-relative flex-grow-1">
      <input type="text" class="form-control copy-field" value="{{ object.old_issi.number }}" readonly>
      <i class="fa fa-copy position-absolute top-50 end-0 translate-middle-y me-2 text-muted" style="cursor:pointer"></i>
    </div>
  </div>
  {% endif %}

  <!-- TEI nieuwe radio -->
  <div class="mb-2 d-flex align-items-center">
    <strong class="me-2 flex-shrink-0" style="width: 40%;">{% trans "TEI nieuwe radio" %}:</strong>
    <div class="position-relative flex-grow-1">
      <input type="text" class="form-control copy-field" value="{{ object.new_radio.tei_15_str }}" readonly>
      <i class="fa fa-copy position-absolute top-50 end-0 translate-middle-y me-2 text-muted" style="cursor:pointer"></i>
    </div>
  </div>

  <!-- ISSI -->
  <div class="mb-2 d-flex align-items-center">
    <strong class="me-2 flex-shrink-0" style="width: 40%;">ISSI:</strong>
    <div class="position-relative flex-grow-1">
      <input type="text" class="form-control copy-field" value="{{ object.new_issi.number }}" readonly>
      <i class="fa fa-copy position-absolute top-50 end-0 translate-middle-y me-2 text-muted" style="cursor:pointer"></i>
    </div>
  </div>

  <!-- Alias -->
  <div class="mb-2 d-flex align-items-center">
    <strong class="me-2 flex-shrink-0" style="width: 40%;">{% trans "Alias" %}:</strong>
    <div class="position-relative flex-grow-1">
      <input type="text" class="form-control copy-field" value="{{ object.new_issi.alias }}" readonly>
      <i class="fa fa-copy position-absolute top-50 end-0 translate-middle-y me-2 text-muted" style="cursor:pointer"></i>
    </div>
  </div>

  <form method="post" action="">

    {% csrf_token %}

    <!-- Astrid ticket -->
    {% if object.status.code == "NEW" and perms.astrid.has_access_to_myastrid %}

      <div class="mb-2 d-flex flex-column">
        <div class="d-flex align-items-center mb-2">
          <strong class="me-2 flex-shrink-0" style="width: 40%;">{% trans "Astrid ticket" %}:</strong>
          <input type="text" name="astrid_ticket" class="form-control flex-grow-1" placeholder="Ticket nummer">
        </div>
      </div>

    {% else %}

      <div class="mb-2 d-flex align-items-center">
        <strong class="me-2 flex-shrink-0" style="width: 40%;">{% trans "Astrid ticket" %}:</strong>
        <div class="position-relative flex-grow-1">
          <input type="text" class="form-control copy-field" value="{{ object.external_reference }}" readonly>
          <i class="fa fa-copy position-absolute top-50 end-0 translate-middle-y me-2 text-muted" style="cursor:pointer"></i>
        </div>
      </div>

    {% endif %}

    <!-- Opmerkingen -->
    {% if object.logs.exists %}
    <div class="mb-2 d-flex">
      <strong class="me-2 flex-shrink-0" style="width: 40%;">{% trans "Opmerkingen" %}:</strong>
      <div class="flex-grow-1 border rounded p-2" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa;">
        {% for log in object.logs.all %}
          <div class="mb-2">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="me-2">
                <span class="badge bg-secondary">{{ log.status_after.name }}</span>
              </div>
              <small class="text-muted">{{ log.timestamp|date:"d/m/Y H:i" }}</small>
            </div>
            <div>{{ log.note|linebreaksbr }}</div>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}


    {% if object.status.code == "NEW" and perms.astrid.has_access_to_myastrid %}

      <input type="hidden" name="type" value="astrid_request_submitted">

      <!-- Nieuwe opmerking -->
      <div class="mb-2 d-flex">
        <div class="me-2 flex-shrink-0" style="width: 40%;"></div>
          <div class="flex-grow-1">
            <textarea name="note" class="form-control" rows="3" placeholder="{% trans 'Nieuwe opmerking' %}"></textarea>
        </div>
      </div>

      <!-- Buttons -->
      <div class="mb-2 d-flex gap-2">
        <button class="btn btn-success mt-3 flex-grow-1" type="submit" name="action" value="request_submitted">
          {% trans "Aanvraag ingediend" %}
        </button>
        <button class="btn btn-danger mt-3 flex-grow-1" type="submit" name="action" value="refused">
          {% trans "Aanvraag geweigerd" %}
        </button>
      </div>

    {% elif object.status.code == "IN_PROGRESS" and perms.astrid.has_access_to_myastrid %}

      <input type="hidden" name="type" value="feedback_from_astrid">

      <!-- Nieuwe opmerking -->
      <div class="mb-2 d-flex">
        <div class="me-2 flex-shrink-0" style="width: 40%;"></div>
          <div class="flex-grow-1">
            <textarea name="note" class="form-control" rows="3" placeholder="{% trans 'Nieuwe opmerking' %}"></textarea>
        </div>
      </div>

      <!-- Buttons -->
      <div class="mb-2 d-flex gap-2">
        <button class="btn btn-success mt-3 flex-grow-1" type="submit" name="action" value="precessed">
          {% trans "Aanvraag verwerkt" %}
        </button>
        <button class="btn btn-danger mt-3 flex-grow-1" type="submit" name="action" value="refused">
          {% trans "Aanvraag geweigerd" %}
        </button>
      </div>

    {% elif object.status.code == "WAITING_VERIFICATION" and perms.astrid.can_verify_requests%}

      <input type="hidden" name="type" value="validate_activation">

      <!-- Nieuwe opmerking -->
      <div class="mb-2 d-flex">
        <div class="me-2 flex-shrink-0" style="width: 40%;"></div>
          <div class="flex-grow-1">
            <textarea name="note" class="form-control" rows="3" placeholder="{% trans 'Nieuwe opmerking' %}"></textarea>
        </div>
      </div>

      <!-- Buttons -->
      <div class="mb-2 d-flex gap-2">
        <button class="btn btn-success mt-3 flex-grow-1" type="submit" name="action" value="radio_is_working">
          {% trans "Radio is working" %}
        </button>
        <button class="btn btn-danger mt-3 flex-grow-1" type="submit" name="action" value="radio_is_not_working">
          {% trans "Radio does not work" %}
        </button>
      </div>

    {% endif %}

  </form>

</div>

<script>
function copyInput(input) {
    if (navigator.clipboard && window.isSecureContext) {
        // Moderne manier
        navigator.clipboard.writeText(input.value)
            .then(() => console.log("Copied:", input.value))
            .catch(err => console.error("Clipboard error:", err));
    } else {
        // Fallback
        input.select();
        input.setSelectionRange(0, 99999); // voor mobiel
        document.execCommand("copy");
        console.log("Copied (fallback):", input.value);
    }
}

// Koppelen aan alle copy-fields
document.querySelectorAll('.copy-field').forEach(input => {
    input.addEventListener('click', () => copyInput(input));
});

// Koppelen aan icoontje
document.querySelectorAll('.fa-copy').forEach(icon => {
    icon.addEventListener('click', () => {
        let input = icon.previousElementSibling;
        if (input) copyInput(input);
    });
});
</script>












{% endblock %}