{% extends "base.html" %}
{% load radio_selector_tags static i18n %}

{% block content %}

<h1 class="mb-3">{% trans "VTEI aanvragen" %}</h1>

<div class="mb-4">
  <p>
    {% blocktranslate %}
    VTEI is een aanvraag om het abonnement van een radio over te zetten op een nieuwe radio met behoud van het ISSI op de nieuwe radio.
    {% endblocktranslate %}
  </p>
</div>

<form method="post">
  {% csrf_token %}
  <div class="row g-4">

    <div class="col radio-widget">
      <div class="border rounded p-2 h-100 d-flex flex-column position-relative">
        <h5 class="text-center mb-3">{% trans "Oude radio" %}</h5>
        <div class="overflow-auto text-center">
          <div class="radio-card" id="old-radio-card">
            {% if ticket %}
              {% radio_selector_button selected=ticket.radio.pk %}
            {% else %}
              {% radio_selector_button %}
            {% endif %}
          </div>
        </div>
      </div>
      <input type="hidden" name="old-radio" class="hidden-radio-input"
             value="{% if ticket %}{{ ticket.radio.pk }}{% endif %}">
    </div>

    <div class="col radio-widget">
      <div class="border rounded p-2 h-100 d-flex flex-column position-relative">
        <h5 class="text-center mb-3">{% trans "Nieuwe radio" %}</h5>
        <div class="overflow-auto text-center">
          <div class="radio-card" id="new-radio-card">
            {% radio_selector_button %}
          </div>
        </div>
      </div>
      <input type="hidden" name="new-radio" class="hidden-radio-input">
    </div>
  </div>

  <div class="row mt-3">
    <div class="col">
      <label for="request-description">{% trans "Reden" %}</label>
      <textarea class="form-control" id="request-description" name="request_description" rows="3" placeholder="{% trans 'Omschrijf hier de reden van de aanvraag' %}">{% if ticket %}Aanvraag gekoppeld aan ticket #{{ ticket.id }} â€“ {{ ticket.title }}{% endif %}</textarea>
    </div>
  </div>

  <div class="row mt-3">
    <div class="col text-center">
      <button type="submit" class="btn btn-primary">Aanvragen</button>
    </div>
  </div>
</form>

{% radio_selector_modal %}

<script>
  function radio_selector_callback(btn, data){
    const card = btn.parentElement;
    const hidden_input = card.closest(".radio-widget").querySelector(".hidden-radio-input");
    hidden_input.value = data.tei;
    card.dataset.tei = data.tei;
  }

  // --- Alleen initialiseren met de ticket-radio ---
  document.addEventListener("DOMContentLoaded", function() {
    const oldRadioId = "{{ preselected_radio.pk|default:'' }}";
    const oldCard = document.querySelector("#old-radio-card");

    if (oldRadioId && oldCard) {
      oldCard.dataset.tei = oldRadioId;
      const input = oldCard.closest(".radio-widget").querySelector(".hidden-radio-input");
      if (input) input.value = oldRadioId;
    }
  });
</script>

{% endblock %}



{% block extra_script %}

  <script src="https://cdn.jsdelivr.net/npm/timeago.js@4.0.2/dist/timeago.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/timeago.js@4.0.2/dist/timeago.locales.min.js"></script>
  <script src="{% static 'js/radio_card.js' %}"></script>

{% endblock %}